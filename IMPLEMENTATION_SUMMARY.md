# ZPay æ”¯ä»˜é›†æˆå®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»æ–‡ä»¶

**æ–‡ä»¶**: `migrations/001_create_zpay_transactions.sql`

åˆ›å»ºäº† `zpay_transactions` è¡¨ï¼ŒåŒ…å«ï¼š

- è®¢å•åŸºæœ¬ä¿¡æ¯ï¼ˆè®¢å•å·ã€é‡‘é¢ã€äº§å“ä¿¡æ¯ï¼‰
- æ”¯ä»˜çŠ¶æ€è·Ÿè¸ª
- è®¢é˜…ä¿¡æ¯ï¼ˆå¼€å§‹/ç»“æŸæ—¶é—´ã€è®¢é˜…å‘¨æœŸï¼‰
- å®Œæ•´çš„ç´¢å¼•å’Œ RLS ç­–ç•¥
- è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³è§¦å‘å™¨

### 2. API ç«¯ç‚¹å®ç°

#### è·å–æ”¯ä»˜é“¾æ¥ API

**æ–‡ä»¶**: `app/api/checkout/providers/zpay/url/route.ts`

åŠŸèƒ½ï¼š

- âœ… ç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆå¿…é¡»ç™»å½•ï¼‰
- âœ… äº§å“ä¿¡æ¯éªŒè¯
- âœ… è®¢å•å·ç”Ÿæˆï¼ˆæ—¶é—´æˆ³ + éšæœºæ•°ï¼‰
- âœ… è®¢é˜…æ—¶é—´è®¡ç®—ï¼ˆæ”¯æŒç»­è®¢é€»è¾‘ï¼‰
- âœ… æ•°æ®åº“è®¢å•è®°å½•åˆ›å»º
- âœ… MD5 ç­¾åç”Ÿæˆ
- âœ… æ”¯ä»˜ URL æ‹¼æ¥

è®¢é˜…ç»­è®¢é€»è¾‘ï¼š

- å¦‚æœç”¨æˆ·æœ‰æœªè¿‡æœŸè®¢é˜…ï¼Œæ–°è®¢é˜…ä»è¿‡æœŸæ—¶é—´å¼€å§‹
- å¦‚æœç”¨æˆ·è®¢é˜…å·²è¿‡æœŸï¼Œæ–°è®¢é˜…ä»å½“å‰æ—¶é—´å¼€å§‹
- é¿å…è®¢é˜…æ—¶é—´é‡å 

#### æ”¯ä»˜å›è°ƒ Webhook API

**æ–‡ä»¶**: `app/api/checkout/providers/zpay/webhook/route.ts`

åŠŸèƒ½ï¼š

- âœ… ç­¾åéªŒè¯ï¼ˆé˜²æ­¢ä¼ªé€ é€šçŸ¥ï¼‰
- âœ… PID éªŒè¯ï¼ˆç¡®è®¤æ¥æºï¼‰
- âœ… é‡‘é¢éªŒè¯ï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰
- âœ… è®¢å•çŠ¶æ€æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
- âœ… æ”¯ä»˜çŠ¶æ€æ›´æ–°
- âœ… æ”¯æŒ GET å’Œ POST æ–¹æ³•
- âœ… è¿”å› "success" æˆ– "fail"

### 3. å‰ç«¯é›†æˆ

#### æ›´æ–° Pricing ç»„ä»¶

**æ–‡ä»¶**: `components/pricing.tsx`

åŠŸèƒ½ï¼š

- âœ… ç”¨æˆ·ç™»å½•æ£€æŸ¥
- âœ… æœªç™»å½•è·³è½¬åˆ° `/signin`
- âœ… è°ƒç”¨æ”¯ä»˜ URL API
- âœ… è‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- âœ… åŠ è½½çŠ¶æ€æ˜¾ç¤º

### 4. æ–‡æ¡£

#### é›†æˆæ–‡æ¡£

**æ–‡ä»¶**: `ZPAY_INTEGRATION.md`

åŒ…å«ï¼š

- ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜
- æ•°æ®åº“è®¾ç½®æ­¥éª¤
- API ç«¯ç‚¹è¯¦ç»†è¯´æ˜
- å®Œæ•´ä½¿ç”¨æµç¨‹
- è®¢é˜…é€»è¾‘è¯¦è§£
- å®‰å…¨æ€§è¯´æ˜
- æµ‹è¯•æŒ‡å—
- å¸¸è§é—®é¢˜è§£ç­”

#### ç¯å¢ƒå˜é‡æ¨¡æ¿

**æ–‡ä»¶**: `.env.local.example`

æä¾›æ‰€éœ€çš„ç¯å¢ƒå˜é‡æ¨¡æ¿

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **ç­¾åéªŒè¯**: æ‰€æœ‰å›è°ƒéƒ½è¿›è¡Œ MD5 ç­¾åéªŒè¯
2. **é‡‘é¢éªŒè¯**: é˜²æ­¢é‡‘é¢ç¯¡æ”¹æ”»å‡»
3. **é‡å¤æ”¯ä»˜é˜²æŠ¤**: æ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œé¿å…é‡å¤å¤„ç†
4. **PID éªŒè¯**: ç¡®è®¤å›è°ƒæ¥æºåˆæ³•æ€§
5. **æœåŠ¡è§’è‰²å¯†é’¥**: ä½¿ç”¨ `createServerAdminClient()` è¿›è¡Œæ•°æ®åº“æ“ä½œ
6. **RLS ç­–ç•¥**: ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„äº¤æ˜“è®°å½•

## ğŸ“Š è®¢é˜…é€»è¾‘ç¤ºä¾‹

### åœºæ™¯ 1: é¦–æ¬¡è®¢é˜…

```
ç”¨æˆ·åœ¨ 2025-03-15 è®¢é˜…æœˆä»˜
å¼€å§‹: 2025-03-15
ç»“æŸ: 2025-04-15
```

### åœºæ™¯ 2: æœªè¿‡æœŸç»­è®¢

```
å½“å‰è®¢é˜…: 2025-04-15 è¿‡æœŸ
ç”¨æˆ·åœ¨ 2025-04-01 ç»­è®¢æœˆä»˜
å¼€å§‹: 2025-04-15 (ä»ä¸Šæ¬¡è¿‡æœŸæ—¶é—´å¼€å§‹)
ç»“æŸ: 2025-05-15
```

### åœºæ™¯ 3: è¿‡æœŸåç»­è®¢

```
è®¢é˜…å·²äº 2025-04-15 è¿‡æœŸ
ç”¨æˆ·åœ¨ 2025-05-01 é‡æ–°è®¢é˜…
å¼€å§‹: 2025-05-01 (å½“å‰æ—¶é—´)
ç»“æŸ: 2025-06-01
```

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### 1. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.local.example` åˆ° `.env.local` å¹¶å¡«å†™ï¼š

```bash
cp .env.local.example .env.local
```

ç¼–è¾‘ `.env.local`ï¼š

```env
NEXT_PUBLIC_SUPABASE_URL=your_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_key
SUPABASE_SERVICE_ROLE_KEY=your_service_key
NEXT_PUBLIC_BASE_URL=http://localhost:3000
ZPAY_PID=your_zpay_pid
ZPAY_KEY=your_zpay_key
```

### 2. è¿è¡Œæ•°æ®åº“è¿ç§»

åœ¨ Supabase Dashboard > SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- å¤åˆ¶ migrations/001_create_zpay_transactions.sql çš„å†…å®¹å¹¶æ‰§è¡Œ
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

### 4. æµ‹è¯•æ”¯ä»˜æµç¨‹

1. è®¿é—®å®šä»·é¡µé¢
2. ç‚¹å‡»è´­ä¹°æŒ‰é’®
3. å¦‚æœªç™»å½•ï¼Œä¼šè·³è½¬åˆ°ç™»å½•é¡µ
4. ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
5. å®Œæˆæ”¯ä»˜åè¿”å›æˆåŠŸé¡µé¢

### 5. é…ç½® Webhookï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

åœ¨ ZPay åå°é…ç½®å›è°ƒåœ°å€ï¼š

```
https://yourdomain.com/api/checkout/providers/zpay/webhook
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 001_create_zpay_transactions.sql    # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ checkout/
â”‚   â”‚       â””â”€â”€ providers/
â”‚   â”‚           â””â”€â”€ zpay/
â”‚   â”‚               â”œâ”€â”€ url/
â”‚   â”‚               â”‚   â””â”€â”€ route.ts        # è·å–æ”¯ä»˜é“¾æ¥ API
â”‚   â”‚               â””â”€â”€ webhook/
â”‚   â”‚                   â””â”€â”€ route.ts        # æ”¯ä»˜å›è°ƒ API
â”‚   â””â”€â”€ payment/
â”‚       â””â”€â”€ success/
â”‚           â””â”€â”€ page.tsx                    # æ”¯ä»˜æˆåŠŸé¡µé¢ï¼ˆå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ components/
â”‚   â””â”€â”€ pricing.tsx                         # å®šä»·ç»„ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ supabase/
â”‚       â”œâ”€â”€ client.ts                       # å®¢æˆ·ç«¯ Supabase
â”‚       â””â”€â”€ server.ts                       # æœåŠ¡ç«¯ Supabase
â”œâ”€â”€ .env.local.example                      # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ ZPAY_INTEGRATION.md                     # é›†æˆæ–‡æ¡£

```

## âœ… æ„å»ºéªŒè¯

é¡¹ç›®å·²é€šè¿‡ Next.js æ„å»ºéªŒè¯ï¼š

```bash
npm run build
# âœ“ Build successful
```

æ‰€æœ‰ API è·¯ç”±å·²æ­£ç¡®æ³¨å†Œï¼š

- `/api/checkout/providers/zpay/url`
- `/api/checkout/providers/zpay/webhook`

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **é…ç½®ç¯å¢ƒå˜é‡**: å¡«å†™ `.env.local` æ–‡ä»¶
2. **è¿è¡Œæ•°æ®åº“è¿ç§»**: åœ¨ Supabase ä¸­æ‰§è¡Œ SQL
3. **æµ‹è¯•æ”¯ä»˜æµç¨‹**: åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
4. **é…ç½®ç”Ÿäº§ Webhook**: éƒ¨ç½²ååœ¨ ZPay åå°é…ç½®
5. **æ·»åŠ ä¸šåŠ¡é€»è¾‘**: åœ¨ webhook ä¸­æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼ˆå¦‚å‘é€é‚®ä»¶ã€æ›´æ–°ç”¨æˆ·æƒé™ç­‰ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æœ¬åœ°æµ‹è¯•**: éœ€è¦ä½¿ç”¨ ngrok ç­‰å·¥å…·æš´éœ²æœ¬åœ°æœåŠ¡ï¼Œä»¥ä¾¿ ZPay èƒ½å¤Ÿå›è°ƒ
2. **ç­¾åå¯†é’¥**: `ZPAY_KEY` å¿…é¡»ä¿å¯†ï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
3. **é‡‘é¢ç²¾åº¦**: ä½¿ç”¨ `DECIMAL(10, 2)` å­˜å‚¨é‡‘é¢ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
4. **è®¢é˜…ç®¡ç†**: å¯ä»¥åˆ›å»ºå®šæ—¶ä»»åŠ¡æ£€æŸ¥è®¢é˜…åˆ°æœŸæƒ…å†µ
5. **é”™è¯¯å¤„ç†**: ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯ç›‘æ§

## ğŸ”§ ä¾èµ–åŒ…

å·²å®‰è£…çš„ä¾èµ–ï¼š

- `@supabase/ssr`: Supabase SSR æ”¯æŒ
- `@supabase/supabase-js`: Supabase å®¢æˆ·ç«¯
- `utility`: MD5 åŠ å¯†ï¼ˆå·²åœ¨ package.json ä¸­ï¼‰

æ— éœ€å®‰è£…é¢å¤–ä¾èµ–ï¼

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š

- `ZPAY_INTEGRATION.md` è¯¦ç»†æ–‡æ¡£
- ZPay å®˜æ–¹æ–‡æ¡£
- Supabase æ–‡æ¡£

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-12-03
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶é€šè¿‡æ„å»ºéªŒè¯
