# ZPay 支付流程图

## 完整支付流程

```
┌─────────────┐
│   用户访问   │
│  定价页面    │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│  点击购买按钮    │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐      否    ┌──────────────┐
│  检查登录状态    ├──────────→│ 跳转登录页面  │
└──────┬──────────┘            └──────────────┘
       │ 是
       ▼
┌─────────────────────────────────────────┐
│  调用 POST /api/checkout/providers/     │
│         zpay/url                         │
│                                          │
│  1. 验证用户身份                          │
│  2. 获取产品信息                          │
│  3. 生成订单号                            │
│  4. 计算订阅时间（如果是订阅产品）         │
│  5. 创建数据库记录（status: pending）     │
│  6. 生成 MD5 签名                         │
│  7. 返回支付 URL                          │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────┐
│  跳转到 ZPay    │
│   支付页面       │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│  用户完成支付    │
└──────┬──────────┘
       │
       ├────────────────────────────────┐
       │                                │
       ▼                                ▼
┌──────────────┐              ┌─────────────────┐
│ 页面跳转通知  │              │  异步回调通知    │
│ (return_url) │              │  (notify_url)   │
└──────┬───────┘              └────────┬────────┘
       │                               │
       ▼                               ▼
┌──────────────┐      ┌────────────────────────────────────┐
│ 支付成功页面  │      │ GET /api/checkout/providers/       │
│              │      │      zpay/webhook                   │
└──────────────┘      │                                     │
                      │  1. 验证签名                         │
                      │  2. 验证 PID                         │
                      │  3. 验证金额                         │
                      │  4. 检查订单状态（防重复）            │
                      │  5. 更新订单状态为 success           │
                      │  6. 记录支付时间                      │
                      │  7. 返回 "success"                   │
                      └────────────────────────────────────┘
```

## 订阅续费逻辑流程

```
┌──────────────────┐
│  用户购买订阅     │
└────────┬─────────┘
         │
         ▼
┌────────────────────────────┐
│  查询用户现有订阅记录       │
└────────┬───────────────────┘
         │
         ▼
    ┌────┴────┐
    │ 是否有   │
    │ 未过期   │  否
    │ 订阅？   ├──────────┐
    └────┬────┘          │
         │ 是            │
         ▼               ▼
┌─────────────────┐  ┌──────────────────┐
│ 从过期时间开始   │  │ 从当前时间开始    │
│ 计算新订阅       │  │ 计算新订阅        │
└────────┬────────┘  └────────┬─────────┘
         │                    │
         └────────┬───────────┘
                  │
                  ▼
         ┌────────────────┐
         │  计算结束时间   │
         │                │
         │ 月付: +1 月    │
         │ 年付: +1 年    │
         └────────┬───────┘
                  │
                  ▼
         ┌────────────────┐
         │  保存订阅信息   │
         └────────────────┘
```

## 订阅续费示例

### 示例 1: 未过期续订

```
时间轴:
2025-03-15          2025-04-01          2025-04-15          2025-05-15
    │                   │                   │                   │
    │◄──────订阅1────────┤                   │                   │
    │                   │                   │                   │
    │                   │◄──────订阅2───────────────────────────►│
    │                   │                   │                   │

说明:
- 2025-03-15: 用户首次订阅月付（订阅1）
- 2025-04-15: 订阅1 到期
- 2025-04-01: 用户续订（订阅2），从 2025-04-15 开始
- 2025-05-15: 订阅2 到期
```

### 示例 2: 过期后续订

```
时间轴:
2025-03-15          2025-04-15          2025-05-01          2025-06-01
    │                   │                   │                   │
    │◄──────订阅1────────┤                   │                   │
    │                   │                   │                   │
    │                   │    (已过期)        │◄──────订阅2───────►│
    │                   │                   │                   │

说明:
- 2025-03-15: 用户首次订阅月付（订阅1）
- 2025-04-15: 订阅1 到期
- 2025-05-01: 用户重新订阅（订阅2），从当前时间开始
- 2025-06-01: 订阅2 到期
```

## 数据库状态流转

```
┌──────────┐
│  创建订单 │
└────┬─────┘
     │
     ▼
┌──────────────┐
│   pending    │  ◄─── 初始状态
└────┬─────────┘
     │
     ├─────────────────┐
     │                 │
     ▼                 ▼
┌──────────┐      ┌──────────┐
│ success  │      │  failed  │
└──────────┘      └──────────┘
     ▲                 ▲
     │                 │
     │                 │
支付成功回调      支付失败回调
```

## 安全验证流程

```
┌──────────────────┐
│  收到 Webhook    │
└────────┬─────────┘
         │
         ▼
┌────────────────────┐
│  1. 验证签名        │
│                    │
│  参数排序 → MD5    │
│  比对签名          │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  2. 验证 PID       │
│                    │
│  检查商户 ID       │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  3. 查询订单        │
│                    │
│  检查订单是否存在   │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  4. 检查订单状态    │
│                    │
│  防止重复处理      │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  5. 验证金额        │
│                    │
│  订单金额 = 回调金额│
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  6. 更新订单状态    │
│                    │
│  pending → success │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│  7. 返回 success   │
└────────────────────┘
```

## API 调用时序图

```
前端              API Server          Supabase          ZPay
 │                    │                  │               │
 │  点击购买           │                  │               │
 ├───────────────────►│                  │               │
 │                    │  验证用户         │               │
 │                    ├─────────────────►│               │
 │                    │◄─────────────────┤               │
 │                    │                  │               │
 │                    │  创建订单         │               │
 │                    ├─────────────────►│               │
 │                    │◄─────────────────┤               │
 │                    │                  │               │
 │  返回支付 URL       │                  │               │
 │◄───────────────────┤                  │               │
 │                    │                  │               │
 │  跳转支付页面       │                  │               │
 ├────────────────────────────────────────────────────►│
 │                    │                  │               │
 │  用户支付           │                  │               │
 │◄───────────────────────────────────────────────────┤
 │                    │                  │               │
 │                    │  Webhook 回调     │               │
 │                    │◄─────────────────────────────────┤
 │                    │                  │               │
 │                    │  验证签名/金额    │               │
 │                    │                  │               │
 │                    │  更新订单状态     │               │
 │                    ├─────────────────►│               │
 │                    │◄─────────────────┤               │
 │                    │                  │               │
 │                    │  返回 success     │               │
 │                    ├──────────────────────────────────►│
 │                    │                  │               │
 │  跳转成功页面       │                  │               │
 │◄───────────────────────────────────────────────────┤
 │                    │                  │               │
```

## 文件依赖关系

```
components/pricing.tsx
        │
        ├─► utils/supabase/client.ts
        │
        └─► app/api/checkout/providers/zpay/url/route.ts
                    │
                    ├─► utils/supabase/server.ts
                    │           │
                    │           └─► createServerAdminClient()
                    │
                    └─► utility (MD5)

app/api/checkout/providers/zpay/webhook/route.ts
        │
        ├─► utils/supabase/server.ts
        │           │
        │           └─► createServerAdminClient()
        │
        └─► utility (MD5)

migrations/001_create_zpay_transactions.sql
        │
        └─► Supabase Database
                    │
                    └─► zpay_transactions table
```

---

**说明**:

- `─►` 表示调用或依赖关系
- `◄─` 表示返回或响应
- `├─` 表示分支或多个操作
